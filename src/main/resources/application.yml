# ========================================
# User Service - 내부 설정 (Bootstrap Configuration)
# ========================================
# 이 파일은 Config Server 연결 전에 로드되는 최소 설정입니다.
# Config Server에서 나머지 설정(DB, Kafka, Resilience4j 등)을 가져옵니다.
#
# 왜 여기에 Eureka 설정이 있나요?
# → Config Server를 Eureka에서 찾으려면 (discovery.enabled=true)
#   Eureka 연결이 먼저 되어야 합니다. (닭과 달걀 문제 해결)
# ========================================

spring:
  # ----- 서비스 식별 정보 -----
  # Eureka 등록명, 로깅, 메트릭 태그 등에 사용됨
  application:
    name: user-service

  # ----- Config Server 연결 설정 -----
  config:
    # optional: Config Server 연결 실패해도 애플리케이션 시작 가능
    # configserver: Spring Cloud Config Server에서 설정 import
    import: 'optional:configserver:'

  cloud:
    config:
      discovery:
        # true: Eureka에서 config-server 서비스를 찾아서 연결
        # false: 직접 URI 지정 (spring.cloud.config.uri)
        enabled: true
        # Eureka에 등록된 Config Server의 서비스 ID
        service-id: config-server

      # Config Server 연결 실패 시 동작
      # true: 즉시 실패 (운영 환경 권장)
      # false: 로컬 설정으로 계속 실행 (개발 환경)
      fail-fast: false

      # Config Server 연결 재시도 설정
      retry:
        initial-interval: 1000   # 첫 재시도 대기 시간 (1초)
        max-attempts: 3          # 최대 재시도 횟수
        max-interval: 2000       # 최대 대기 시간 (2초)
        multiplier: 1.1          # 대기 시간 증가 배율

# ----- 서버 설정 -----
server:
  # 서비스 포트 (환경변수로 오버라이드 가능)
  port: ${SERVER_PORT:8087}
  # graceful: 종료 시 진행 중인 요청 완료 후 종료
  # immediate: 즉시 종료
  shutdown: graceful

# ========================================
# Eureka Client 설정
# ========================================
# Config Server 연결 전에 반드시 필요한 설정
# Eureka를 통해 Config Server를 찾기 때문
# ========================================
eureka:
  instance:
    # ----- 인스턴스 식별 설정 -----
    # Docker 환경에서는 컨테이너 이름 사용
    # 환경변수로 오버라이드: EUREKA_INSTANCE_HOSTNAME
    hostname: ${EUREKA_INSTANCE_HOSTNAME:${spring.application.name}}

    # Eureka 대시보드에 표시되는 고유 ID
    # 형식: hostname:port (예: user-service:8087)
    instance-id: ${eureka.instance.hostname}:${server.port}

    # false: hostname 사용 (Docker 네트워크에서 컨테이너명으로 통신)
    # true: IP 주소 사용 (K8s 환경 등)
    prefer-ip-address: false

    # ----- 하트비트 설정 -----
    # Eureka 서버에 "나 살아있어요" 신호 전송 주기
    lease-renewal-interval-in-seconds: 10

    # 이 시간 동안 하트비트 없으면 Eureka에서 제거됨
    # lease-renewal-interval의 3배 권장
    lease-expiration-duration-in-seconds: 30

  client:
    # ----- 등록/조회 설정 -----
    # true: 이 서비스를 Eureka에 등록
    register-with-eureka: true

    # true: 다른 서비스 목록을 Eureka에서 가져옴
    # Feign Client, LoadBalancer가 사용
    fetch-registry: true

    # ----- Eureka 서버 주소 -----
    # 이중화된 Eureka 서버 주소 (콤마로 구분)
    # 첫 번째 서버 실패 시 두 번째 서버로 자동 전환
    service-url:
      defaultZone: ${EUREKA_CLIENT_SERVICEURL_DEFAULTZONE:http://localhost:8761/eureka/}

    # 서비스 목록 갱신 주기 (초)
    # 짧을수록 새 서비스 인스턴스를 빨리 인식
    registry-fetch-interval-seconds: 5